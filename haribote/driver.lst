     1 00000000                                 [FORMAT "WCOFF"]
     2 00000000                                 [INSTRSET "i486p"]
     3 00000000                                 [OPTIMIZE 1]
     4 00000000                                 [OPTION 1]
     5 00000000                                 [BITS 32]
     6 00000000                                 	EXTERN	_HDEntry
     7 00000000                                 	EXTERN	_FSEntry
     8 00000000                                 	EXTERN	_io_cli
     9 00000000                                 	EXTERN	_io_sti
    10 00000000                                 	EXTERN	_file_search
    11 00000000                                 	EXTERN	_memman_alloc_4k
    12 00000000                                 	EXTERN	_file_loadfile
    13 00000000                                 	EXTERN	_task_alloc
    14 00000000                                 	EXTERN	_task_run
    15 00000000                                 	EXTERN	_strcmp
    16 00000000                                 	EXTERN	_task_now
    17 00000000                                 	EXTERN	_set_segmdesc
    18 00000000                                 	EXTERN	_start_sys
    19 00000000                                 	EXTERN	_task_sleep
    20 00000000                                 [FILE "driver.c"]
    21 00000000                                 	GLOBAL	_dDevs
    22                                          [SECTION .data]
    23 00000000                                 LC0:
    24 00000000 49 64 65 20 48 44 00            	DB	"Ide HD",0x00
    25 00000007                                 LC1:
    26 00000007 46 53 00                        	DB	"FS",0x00
    27 0000000A 00 00                           	ALIGNB	4
    28 0000000C                                 _dDevs:
    29 0000000C [00000000]                      	DD	LC0
    30 00000010 [00000000]                      	DD	_HDEntry
    31 00000014 00 00 00 00                     	RESB	4
    32 00000018 [00000007]                      	DD	LC1
    33 0000001C [00000000]                      	DD	_FSEntry
    34 00000020 00 00 00 00                     	RESB	4
    35 00000024                                 	GLOBAL	_etable
    36 00000024                                 LC2:
    37 00000024 74 65 73 74 00                  	DB	"test",0x00
    38 00000029                                 LC3:
    39 00000029 73 79 73 74 65 73 74 2E 73 79   	DB	"systest.sys",0x00
       00000033 73 00 
    40 00000035 00 00 00                        	ALIGNB	4
    41 00000038                                 _etable:
    42 00000038 [00000024]                      	DD	LC2
    43 0000003C [00000029]                      	DD	LC3
    44 00000040 00 00 00 00                     	RESB	4
    45                                          [SECTION .text]
    46 00000000                                 	GLOBAL	_LDevs
    47 00000000                                 _LDevs:
    48 00000000 55                              	PUSH	EBP
    49 00000001 89 E5                           	MOV	EBP,ESP
    50 00000003 57                              	PUSH	EDI
    51 00000004 56                              	PUSH	ESI
    52 00000005 31 FF                           	XOR	EDI,EDI
    53 00000007 53                              	PUSH	EBX
    54 00000008 31 F6                           	XOR	ESI,ESI
    55 0000000A 83 EC 10                        	SUB	ESP,16
    56 0000000D E8 [00000000]                   	CALL	_io_cli
    57 00000012                                 L7:
    58 00000012 8B 86 [0000000C]                	MOV	EAX,DWORD [_dDevs+ESI]
    59 00000018 8D 5D E4                        	LEA	EBX,DWORD [-28+EBP]
    60 0000001B 89 45 E4                        	MOV	DWORD [-28+EBP],EAX
    61 0000001E 89 9E [00000014]                	MOV	DWORD [_dDevs+8+ESI],EBX
    62 00000024 8B 45 08                        	MOV	EAX,DWORD [8+EBP]
    63 00000027 89 45 E8                        	MOV	DWORD [-24+EBP],EAX
    64 0000002A E8 [00000000]                   	CALL	_io_sti
    65 0000002F 53                              	PUSH	EBX
    66 00000030 FF 96 [00000010]                	CALL	DWORD [_dDevs+4+ESI]
    67 00000036 5A                              	POP	EDX
    68 00000037 31 D2                           	XOR	EDX,EDX
    69 00000039 85 C0                           	TEST	EAX,EAX
    70 0000003B 74 13                           	JE	L1
    71 0000003D 47                              	INC	EDI
    72 0000003E 83 C6 0C                        	ADD	ESI,12
    73 00000041 83 FF 01                        	CMP	EDI,1
    74 00000044 7E CC                           	JLE	L7
    75 00000046 E8 [00000000]                   	CALL	_io_sti
    76 0000004B BA 00000001                     	MOV	EDX,1
    77 00000050                                 L1:
    78 00000050 8D 65 F4                        	LEA	ESP,DWORD [-12+EBP]
    79 00000053 89 D0                           	MOV	EAX,EDX
    80 00000055 5B                              	POP	EBX
    81 00000056 5E                              	POP	ESI
    82 00000057 5F                              	POP	EDI
    83 00000058 5D                              	POP	EBP
    84 00000059 C3                              	RET
    85 0000005A                                 	GLOBAL	_load_external_device
    86 0000005A                                 _load_external_device:
    87 0000005A 55                              	PUSH	EBP
    88 0000005B 89 E5                           	MOV	EBP,ESP
    89 0000005D 57                              	PUSH	EDI
    90 0000005E 56                              	PUSH	ESI
    91 0000005F 53                              	PUSH	EBX
    92 00000060 83 EC 18                        	SUB	ESP,24
    93 00000063 C7 45 DC 00000000               	MOV	DWORD [-36+EBP],0
    94 0000006A C7 45 E0 00000000               	MOV	DWORD [-32+EBP],0
    95 00000071                                 L15:
    96 00000071 8B 55 DC                        	MOV	EDX,DWORD [-36+EBP]
    97 00000074 68 000000E0                     	PUSH	224
    98 00000079 68 00102600                     	PUSH	1058304
    99 0000007E 8B 82 [00000038]                	MOV	EAX,DWORD [_etable+EDX]
   100 00000084 89 45 E4                        	MOV	DWORD [-28+EBP],EAX
   101 00000087 8B 45 0C                        	MOV	EAX,DWORD [12+EBP]
   102 0000008A FF B2 [0000003C]                	PUSH	DWORD [_etable+4+EDX]
   103 00000090 89 45 E8                        	MOV	DWORD [-24+EBP],EAX
   104 00000093 8D 45 E4                        	LEA	EAX,DWORD [-28+EBP]
   105 00000096 89 82 [00000040]                	MOV	DWORD [_etable+8+EDX],EAX
   106 0000009C E8 [00000000]                   	CALL	_file_search
   107 000000A1 89 C6                           	MOV	ESI,EAX
   108 000000A3 FF 70 1C                        	PUSH	DWORD [28+EAX]
   109 000000A6 FF 75 0C                        	PUSH	DWORD [12+EBP]
   110 000000A9 E8 [00000000]                   	CALL	_memman_alloc_4k
   111 000000AE 68 00103E00                     	PUSH	1064448
   112 000000B3 FF 75 08                        	PUSH	DWORD [8+EBP]
   113 000000B6 50                              	PUSH	EAX
   114 000000B7 89 C7                           	MOV	EDI,EAX
   115 000000B9 FF 76 1C                        	PUSH	DWORD [28+ESI]
   116 000000BC 0F B7 46 1A                     	MOVZX	EAX,WORD [26+ESI]
   117 000000C0 50                              	PUSH	EAX
   118 000000C1 E8 [00000000]                   	CALL	_file_loadfile
   119 000000C6 83 C4 28                        	ADD	ESP,40
   120 000000C9 E8 [00000000]                   	CALL	_task_alloc
   121 000000CE 68 00010000                     	PUSH	65536
   122 000000D3 89 C3                           	MOV	EBX,EAX
   123 000000D5 FF 75 0C                        	PUSH	DWORD [12+EBP]
   124 000000D8 E8 [00000000]                   	CALL	_memman_alloc_4k
   125 000000DD 05 0000FFF4                     	ADD	EAX,65524
   126 000000E2 89 43 64                        	MOV	DWORD [100+EBX],EAX
   127 000000E5 C7 43 4C [0000018C]             	MOV	DWORD [76+EBX],_opensys
   128 000000EC C7 43 74 00000008               	MOV	DWORD [116+EBX],8
   129 000000F3 C7 43 78 00000010               	MOV	DWORD [120+EBX],16
   130 000000FA C7 43 7C 00000008               	MOV	DWORD [124+EBX],8
   131 00000101 C7 83 00000080 00000008         	MOV	DWORD [128+EBX],8
   132 0000010B C7 83 00000084 00000008         	MOV	DWORD [132+EBX],8
   133 00000115 C7 83 00000088 00000008         	MOV	DWORD [136+EBX],8
   134 0000011F 89 78 04                        	MOV	DWORD [4+EAX],EDI
   135 00000122 8B 53 64                        	MOV	EDX,DWORD [100+EBX]
   136 00000125 8B 46 1C                        	MOV	EAX,DWORD [28+ESI]
   137 00000128 89 42 08                        	MOV	DWORD [8+EDX],EAX
   138 0000012B 6A 01                           	PUSH	1
   139 0000012D 6A 02                           	PUSH	2
   140 0000012F 53                              	PUSH	EBX
   141 00000130 E8 [00000000]                   	CALL	_task_run
   142 00000135 83 C4 14                        	ADD	ESP,20
   143 00000138 83 45 DC 0C                     	ADD	DWORD [-36+EBP],12
   144 0000013C FF 4D E0                        	DEC	DWORD [-32+EBP]
   145 0000013F 0F 89 FFFFFF2C                  	JNS	L15
   146 00000145 8D 65 F4                        	LEA	ESP,DWORD [-12+EBP]
   147 00000148 B8 00000001                     	MOV	EAX,1
   148 0000014D 5B                              	POP	EBX
   149 0000014E 5E                              	POP	ESI
   150 0000014F 5F                              	POP	EDI
   151 00000150 5D                              	POP	EBP
   152 00000151 C3                              	RET
   153 00000152                                 	GLOBAL	_GetMyObj
   154 00000152                                 _GetMyObj:
   155 00000152 55                              	PUSH	EBP
   156 00000153 89 E5                           	MOV	EBP,ESP
   157 00000155 57                              	PUSH	EDI
   158 00000156 56                              	PUSH	ESI
   159 00000157 31 F6                           	XOR	ESI,ESI
   160 00000159 53                              	PUSH	EBX
   161 0000015A 8B 7D 08                        	MOV	EDI,DWORD [8+EBP]
   162 0000015D 31 DB                           	XOR	EBX,EBX
   163 0000015F                                 L24:
   164 0000015F 57                              	PUSH	EDI
   165 00000160 FF B3 [0000000C]                	PUSH	DWORD [_dDevs+EBX]
   166 00000166 E8 [00000000]                   	CALL	_strcmp
   167 0000016B 59                              	POP	ECX
   168 0000016C 5A                              	POP	EDX
   169 0000016D 85 C0                           	TEST	EAX,EAX
   170 0000016F 74 13                           	JE	L27
   171 00000171 46                              	INC	ESI
   172 00000172 83 C3 0C                        	ADD	EBX,12
   173 00000175 83 FE 01                        	CMP	ESI,1
   174 00000178 7E E5                           	JLE	L24
   175 0000017A 31 C0                           	XOR	EAX,EAX
   176 0000017C                                 L18:
   177 0000017C 8D 65 F4                        	LEA	ESP,DWORD [-12+EBP]
   178 0000017F 5B                              	POP	EBX
   179 00000180 5E                              	POP	ESI
   180 00000181 5F                              	POP	EDI
   181 00000182 5D                              	POP	EBP
   182 00000183 C3                              	RET
   183 00000184                                 L27:
   184 00000184 8B 83 [00000014]                	MOV	EAX,DWORD [_dDevs+8+EBX]
   185 0000018A EB F0                           	JMP	L18
   186 0000018C                                 	GLOBAL	_opensys
   187 0000018C                                 _opensys:
   188 0000018C 55                              	PUSH	EBP
   189 0000018D 89 E5                           	MOV	EBP,ESP
   190 0000018F 57                              	PUSH	EDI
   191 00000190 56                              	PUSH	ESI
   192 00000191 53                              	PUSH	EBX
   193 00000192 83 EC 18                        	SUB	ESP,24
   194 00000195 8B 7D 08                        	MOV	EDI,DWORD [8+EBP]
   195 00000198 8B 5D 0C                        	MOV	EBX,DWORD [12+EBP]
   196 0000019B 4B                              	DEC	EBX
   197 0000019C E8 [00000000]                   	CALL	_task_now
   198 000001A1 8B 4F 50                        	MOV	ECX,DWORD [80+EDI]
   199 000001A4 8B 57 40                        	MOV	EDX,DWORD [64+EDI]
   200 000001A7 89 45 F0                        	MOV	DWORD [-16+EBP],EAX
   201 000001AA 8B 37                           	MOV	ESI,DWORD [EDI]
   202 000001AC 8B 47 30                        	MOV	EAX,DWORD [48+EDI]
   203 000001AF 89 4D E4                        	MOV	DWORD [-28+EBP],ECX
   204 000001B2 89 55 E8                        	MOV	DWORD [-24+EBP],EDX
   205 000001B5 89 45 EC                        	MOV	DWORD [-20+EBP],EAX
   206 000001B8 56                              	PUSH	ESI
   207 000001B9 4E                              	DEC	ESI
   208 000001BA 68 003C0000                     	PUSH	3932160
   209 000001BF E8 [00000000]                   	CALL	_memman_alloc_4k
   210 000001C4 8B 55 F0                        	MOV	EDX,DWORD [-16+EBP]
   211 000001C7 89 45 E0                        	MOV	DWORD [-32+EBP],EAX
   212 000001CA 89 82 00000114                  	MOV	DWORD [276+EDX],EAX
   213 000001D0 68 000040BA                     	PUSH	16570
   214 000001D5 57                              	PUSH	EDI
   215 000001D6 53                              	PUSH	EBX
   216 000001D7 BB 00000008                     	MOV	EBX,8
   217 000001DC 8B 02                           	MOV	EAX,DWORD [EDX]
   218 000001DE 99                              	CDQ
   219 000001DF F7 FB                           	IDIV	EBX
   220 000001E1 8D 04 C5 00273E80               	LEA	EAX,DWORD [2571904+EAX*8]
   221 000001E8 50                              	PUSH	EAX
   222 000001E9 E8 [00000000]                   	CALL	_set_segmdesc
   223 000001EE 68 000040B2                     	PUSH	16562
   224 000001F3 FF 75 E0                        	PUSH	DWORD [-32+EBP]
   225 000001F6 56                              	PUSH	ESI
   226 000001F7 8B 4D F0                        	MOV	ECX,DWORD [-16+EBP]
   227 000001FA 8B 01                           	MOV	EAX,DWORD [ECX]
   228 000001FC 99                              	CDQ
   229 000001FD F7 FB                           	IDIV	EBX
   230 000001FF 8D 04 C5 00275DC0               	LEA	EAX,DWORD [2579904+EAX*8]
   231 00000206 50                              	PUSH	EAX
   232 00000207 E8 [00000000]                   	CALL	_set_segmdesc
   233 0000020C 83 C4 28                        	ADD	ESP,40
   234 0000020F 83 7D E8 00                     	CMP	DWORD [-24+EBP],0
   235 00000213 7E 1A                           	JLE	L35
   236 00000215 8B 5D EC                        	MOV	EBX,DWORD [-20+EBP]
   237 00000218 8B 45 E4                        	MOV	EAX,DWORD [-28+EBP]
   238 0000021B 03 5D E0                        	ADD	EBX,DWORD [-32+EBP]
   239 0000021E 8B 55 E8                        	MOV	EDX,DWORD [-24+EBP]
   240 00000221 8D 0C 87                        	LEA	ECX,DWORD [EDI+EAX*4]
   241 00000224                                 L33:
   242 00000224 8A 01                           	MOV	AL,BYTE [ECX]
   243 00000226 83 C1 04                        	ADD	ECX,4
   244 00000229 88 03                           	MOV	BYTE [EBX],AL
   245 0000022B 43                              	INC	EBX
   246 0000022C 4A                              	DEC	EDX
   247 0000022D 75 F5                           	JNE	L33
   248 0000022F                                 L35:
   249 0000022F 8B 45 F0                        	MOV	EAX,DWORD [-16+EBP]
   250 00000232 BB 00000008                     	MOV	EBX,8
   251 00000237 83 C0 30                        	ADD	EAX,48
   252 0000023A 50                              	PUSH	EAX
   253 0000023B 8B 55 F0                        	MOV	EDX,DWORD [-16+EBP]
   254 0000023E 8B 02                           	MOV	EAX,DWORD [EDX]
   255 00000240 99                              	CDQ
   256 00000241 F7 FB                           	IDIV	EBX
   257 00000243 8D 04 C5 00005DC0               	LEA	EAX,DWORD [24000+EAX*8]
   258 0000024A 50                              	PUSH	EAX
   259 0000024B FF 75 EC                        	PUSH	DWORD [-20+EBP]
   260 0000024E 8B 4D F0                        	MOV	ECX,DWORD [-16+EBP]
   261 00000251 8B 01                           	MOV	EAX,DWORD [ECX]
   262 00000253 99                              	CDQ
   263 00000254 F7 FB                           	IDIV	EBX
   264 00000256 8D 04 C5 00003E80               	LEA	EAX,DWORD [16000+EAX*8]
   265 0000025D 50                              	PUSH	EAX
   266 0000025E 6A 1B                           	PUSH	27
   267 00000260 E8 [00000000]                   	CALL	_start_sys
   268 00000265 83 C4 14                        	ADD	ESP,20
   269 00000268 E8 [00000000]                   	CALL	_task_now
   270 0000026D 89 45 08                        	MOV	DWORD [8+EBP],EAX
   271 00000270 8D 65 F4                        	LEA	ESP,DWORD [-12+EBP]
   272 00000273 5B                              	POP	EBX
   273 00000274 5E                              	POP	ESI
   274 00000275 5F                              	POP	EDI
   275 00000276 5D                              	POP	EBP
   276 00000277 E9 [00000000]                   	JMP	_task_sleep
